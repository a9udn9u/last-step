"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const utils_1 = require("~/utils");
const builder_models_1 = require("~/models/builder-models");
const state_models_1 = require("~/models/state-models");
const state_1 = require("~/states/state");
const processor_models_1 = require("~/models/processor-models");
class IncrementalState extends state_1.State {
    constructor(env, rule) {
        super(env, rule);
        this.targetToSources = new state_models_1.TargetToSources();
        this.sourceToTargets = new state_models_1.SourceToTargets();
        this.recompileSources = new Set();
    }
    /**
     * Find files requring re-compile when the given file changed.
     * First find the targets affected by the changed file, then backtrack each
     * execution context, find the original source of each target.
     *
     * File additions will fall through, but caught later in
     * [processorInput()]{@link IncrementalState#processorInput}
     *
     * @param file The added/updated/deleted file.
     * @returns List of files requiring re-compile.
     */
    findReompileSources(source) {
        let targets = this.sourceToTargets.get(source) || new Set();
        let sources = new Set();
        targets.forEach(finalTarget => {
            // Backtracking source
            // TODO: This might be unncecessary though, the key of the output
            // map is the original source (needs confirmation)
            let file = finalTarget;
            for (let i = this.contexts.length - 1; i >= 0; --i) {
                let context = this.contexts[i];
                file = context.output.getByTarget(file).source;
                file = path.relative(context.sourceDir, file);
            }
            sources.add(file);
        });
        utils_1.Utils.dbg() && utils_1.Utils.debug('Re-compile candidates:', sources);
        return sources;
    }
    getLastBuildContext(index) {
        return this.lastBuildContexts ? this.lastBuildContexts[index] : undefined;
    }
    nextRootDir() {
        // At this point, new context hasn't been pushed to this.contexts,
        // so index should be context length without minus one
        let lastBuildContext = this.getLastBuildContext(this.contexts.length);
        return lastBuildContext ? lastBuildContext.rootDir : super.nextRootDir();
    }
    processorInput(context, file) {
        let entry = new processor_models_1.ProcessorInputEntry(path.resolve(context.sourceDir, file), path.resolve(context.workDir, file), false, undefined);
        let lastBuildContext = this.getLastBuildContext(context.index);
        // Original source files in recompileSources should be compiled
        if (context.index === 0) {
            if (this.recompileSources.has(file)) {
                entry.shouldCompile = true;
                utils_1.Utils.dbg() && utils_1.Utils.debug(`Recompile ${file} because itself or its dependencies have changed.`);
            }
        }
        else if (!lastBuildContext) {
            entry.shouldCompile = true;
        }
        else if (!lastBuildContext.output.hasSource(file)) {
            utils_1.Utils.dbg() && utils_1.Utils.debug(`Recompile ${file} because it's new or it failed last time.`);
            entry.shouldCompile = true;
        }
        // When compile is skipped, processor needs output from last build to
        // generate its own output
        if (lastBuildContext) {
            entry.lastOutput = lastBuildContext.output.getBySource(file);
        }
        return entry;
    }
    beforeBuild(task = new builder_models_1.Task()) {
        super.beforeBuild(task);
        // Compute re-compile sources
        this.recompileSources = [...task.values()]
            .reduce((all, batch) => all.concat([...batch]), [])
            .map(file => this.findReompileSources(file))
            .reduce((cands, sources) => utils_1.Utils.union(cands, sources), new Set());
        // Update file list according to file system update
        if (task.has(builder_models_1.EditEvent.ADD)) {
            task.get(builder_models_1.EditEvent.ADD).forEach(f => this.rule.files.add(f));
        }
        if (task.has(builder_models_1.EditEvent.DEL)) {
            task.get(builder_models_1.EditEvent.DEL).forEach(f => this.rule.files.delete(f));
        }
        // Reinitiate TTS
        if (this.rule.files.size) {
            this.targetToSources = new state_models_1.TargetToSources();
            this.rule.files.forEach(f => this.targetToSources.set(f, new Set([f])));
            this.sourceToTargets = this.targetToSources.flip();
        }
        this.lastBuildContexts = this.contexts;
        this.contexts = [];
    }
    /**
     * Transform processor output and save it into context.
     * @param output Results returned by processor.
     */
    saveOutput(output) {
        super.saveOutput(output);
        let context = utils_1.Utils.lastElement(this.contexts);
        // Update targetToSourcesMap and sourceToTargetsMap
        context.targetToSources.trace(this.targetToSources);
        this.targetToSources = context.targetToSources;
        context.sourceToTargets = this.sourceToTargets = this.targetToSources.flip();
        if (utils_1.Utils.dbg()) {
            utils_1.Utils.debug(`${this.name}: TTS`, this.targetToSources);
            utils_1.Utils.debug(`${this.name}: STT`, this.sourceToTargets);
        }
    }
}
exports.IncrementalState = IncrementalState;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5jci1zdGF0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdGF0ZXMvaW5jci1zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3QixtQ0FBZ0M7QUFDaEMsNERBQTZFO0FBQzdFLHdEQUFrRjtBQUNsRiwwQ0FBdUM7QUFDdkMsZ0VBQWlGO0FBRWpGLHNCQUE4QixTQUFRLGFBQUs7SUFxQnpDLFlBQVksR0FBZ0IsRUFBRSxJQUFVO1FBQ3RDLEtBQUssQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLDhCQUFlLEVBQUUsQ0FBQztRQUM3QyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksOEJBQWUsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFFRDs7Ozs7Ozs7OztPQVVHO0lBQ0ssbUJBQW1CLENBQUMsTUFBYztRQUN4QyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLEdBQUcsRUFBVSxDQUFDO1FBQ3BFLElBQUksT0FBTyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDaEMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUM1QixzQkFBc0I7WUFDdEIsaUVBQWlFO1lBQ2pFLGtEQUFrRDtZQUNsRCxJQUFJLElBQUksR0FBRyxXQUFXLENBQUM7WUFDdkIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztnQkFDbkQsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFD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QUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ3ZELGFBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxPQUFPLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3pELENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUF2SkQsNENBdUpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnfi91dGlscyc7XG5pbXBvcnQgeyBFZGl0RXZlbnQsIEVudmlyb25tZW50LCBSdWxlLCBUYXNrIH0gZnJvbSAnfi9tb2RlbHMvYnVpbGRlci1tb2RlbHMnO1xuaW1wb3J0IHsgVGFyZ2V0VG9Tb3VyY2VzLCBTb3VyY2VUb1RhcmdldHMsIENvbnRleHQgfSBmcm9tICd+L21vZGVscy9zdGF0ZS1tb2RlbHMnO1xuaW1wb3J0IHsgU3RhdGUgfSBmcm9tICd+L3N0YXRlcy9zdGF0ZSc7XG5pbXBvcnQgeyBQcm9jZXNzb3JPdXRwdXQsIFByb2Nlc3NvcklucHV0RW50cnkgfSBmcm9tICd+L21vZGVscy9wcm9jZXNzb3ItbW9kZWxzJztcblxuZXhwb3J0IGNsYXNzIEluY3JlbWVudGFsU3RhdGUgZXh0ZW5kcyBTdGF0ZSB7XG4gIC8qKlxuICAgKiAxIHRvIE0gbWFwcGluZywga2V5IGlzIHRoZSB0YXJnZXQgZmlsZSwgdmFsdWUgaXMgYSBzZXQgb2Ygc291cmNlXG4gICAqIGZpbGVzIHdoaWNoIGNvbXBvc2UgdGhlIHRhcmdldCBmaWxlXG4gICAqL1xuICB0YXJnZXRUb1NvdXJjZXM6IFRhcmdldFRvU291cmNlcztcbiAgLyoqXG4gICAqIDEgdG8gTSBtYXBwaW5nLCBrZXkgaXMgdGhlIHNvdXJjZSBmaWxlLCB2YWx1ZSBpcyBhIHNldCBvZiB0YXJnZXRcbiAgICogZmlsZXMgd2hpY2ggY29udGFpbiB0aGUgc291cmNlIGZpbGVcbiAgICovXG4gIHNvdXJjZVRvVGFyZ2V0czogU291cmNlVG9UYXJnZXRzO1xuICAvKipcbiAgICogVGhpcyBpcyBhIHNldCBvZiBzb3VyY2VzIHRoYXQgc2hvdWxkIGJlIGZvcmNlZCB0byByZS1jb21waWxlIGluIHRoZVxuICAgKiBuZXh0IGluY3JlbWVudGFsIGJ1aWxkXG4gICAqL1xuICByZWNvbXBpbGVTb3VyY2VzOiBTZXQ8c3RyaW5nPjtcbiAgLyoqXG4gICAqIENvbmV0eHQgbGlzdCBmcm9tIHRoZSBsYXN0IGJ1aWxkXG4gICAqL1xuICBsYXN0QnVpbGRDb250ZXh0czogQ29udGV4dFtdO1xuXG4gIGNvbnN0cnVjdG9yKGVudjogRW52aXJvbm1lbnQsIHJ1bGU6IFJ1bGUpIHtcbiAgICBzdXBlcihlbnYsIHJ1bGUpO1xuICAgIHRoaXMudGFyZ2V0VG9Tb3VyY2VzID0gbmV3IFRhcmdldFRvU291cmNlcygpO1xuICAgIHRoaXMuc291cmNlVG9UYXJnZXRzID0gbmV3IFNvdXJjZVRvVGFyZ2V0cygpO1xuICAgIHRoaXMucmVjb21waWxlU291cmNlcyA9IG5ldyBTZXQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGaW5kIGZpbGVzIHJlcXVyaW5nIHJlLWNvbXBpbGUgd2hlbiB0aGUgZ2l2ZW4gZmlsZSBjaGFuZ2VkLlxuICAgKiBGaXJzdCBmaW5kIHRoZSB0YXJnZXRzIGFmZmVjdGVkIGJ5IHRoZSBjaGFuZ2VkIGZpbGUsIHRoZW4gYmFja3RyYWNrIGVhY2hcbiAgICogZXhlY3V0aW9uIGNvbnRleHQsIGZpbmQgdGhlIG9yaWdpbmFsIHNvdXJjZSBvZiBlYWNoIHRhcmdldC5cbiAgICpcbiAgICogRmlsZSBhZGRpdGlvbnMgd2lsbCBmYWxsIHRocm91Z2gsIGJ1dCBjYXVnaHQgbGF0ZXIgaW5cbiAgICogW3Byb2Nlc3NvcklucHV0KClde0BsaW5rIEluY3JlbWVudGFsU3RhdGUjcHJvY2Vzc29ySW5wdXR9XG4gICAqXG4gICAqIEBwYXJhbSBmaWxlIFRoZSBhZGRlZC91cGRhdGVkL2RlbGV0ZWQgZmlsZS5cbiAgICogQHJldHVybnMgTGlzdCBvZiBmaWxlcyByZXF1aXJpbmcgcmUtY29tcGlsZS5cbiAgICovXG4gIHByaXZhdGUgZmluZFJlb21waWxlU291cmNlcyhzb3VyY2U6IHN0cmluZyk6IFNldDxzdHJpbmc+IHtcbiAgICBsZXQgdGFyZ2V0cyA9IHRoaXMuc291cmNlVG9UYXJnZXRzLmdldChzb3VyY2UpIHx8IG5ldyBTZXQ8c3RyaW5nPigpO1xuICAgIGxldCBzb3VyY2VzID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gICAgdGFyZ2V0cy5mb3JFYWNoKGZpbmFsVGFyZ2V0ID0+IHtcbiAgICAgIC8vIEJhY2t0cmFja2luZyBzb3VyY2VcbiAgICAgIC8vIFRPRE86IFRoaXMgbWlnaHQgYmUgdW5uY2VjZXNzYXJ5IHRob3VnaCwgdGhlIGtleSBvZiB0aGUgb3V0cHV0XG4gICAgICAvLyBtYXAgaXMgdGhlIG9yaWdpbmFsIHNvdXJjZSAobmVlZHMgY29uZmlybWF0aW9uKVxuICAgICAgbGV0IGZpbGUgPSBmaW5hbFRhcmdldDtcbiAgICAgIGZvciAobGV0IGkgPSB0aGlzLmNvbnRleHRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7XG4gICAgICAgIGxldCBjb250ZXh0ID0gdGhpcy5jb250ZXh0c1tpXTtcbiAgICAgICAgZmlsZSA9IGNvbnRleHQub3V0cHV0LmdldEJ5VGFyZ2V0KGZpbGUpLnNvdXJjZTtcbiAgICAgICAgZmlsZSA9IHBhdGgucmVsYXRpdmUoY29udGV4dC5zb3VyY2VEaXIsIGZpbGUpO1xuICAgICAgfVxuICAgICAgc291cmNlcy5hZGQoZmlsZSk7XG4gICAgfSk7XG4gICAgVXRpbHMuZGJnKCkgJiYgVXRpbHMuZGVidWcoJ1JlLWNvbXBpbGUgY2FuZGlkYXRlczonLCBzb3VyY2VzKTtcbiAgICByZXR1cm4gc291cmNlcztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TGFzdEJ1aWxkQ29udGV4dChpbmRleDogbnVtYmVyKTogQ29udGV4dCB7XG4gICAgcmV0dXJuIHRoaXMubGFzdEJ1aWxkQ29udGV4dHMgPyB0aGlzLmxhc3RCdWlsZENvbnRleHRzW2luZGV4XSA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByb3RlY3RlZCBuZXh0Um9vdERpcigpOiBzdHJpbmcge1xuICAgIC8vIEF0IHRoaXMgcG9pbnQsIG5ldyBjb250ZXh0IGhhc24ndCBiZWVuIHB1c2hlZCB0byB0aGlzLmNvbnRleHRzLFxuICAgIC8vIHNvIGluZGV4IHNob3VsZCBiZSBjb250ZXh0IGxlbmd0aCB3aXRob3V0IG1pbnVzIG9uZVxuICAgIGxldCBsYXN0QnVpbGRDb250ZXh0ID0gdGhpcy5nZXRMYXN0QnVpbGRDb250ZXh0KHRoaXMuY29udGV4dHMubGVuZ3RoKTtcbiAgICByZXR1cm4gbGFzdEJ1aWxkQ29udGV4dCA/IGxhc3RCdWlsZENvbnRleHQucm9vdERpciA6IHN1cGVyLm5leHRSb290RGlyKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgcHJvY2Vzc29ySW5wdXQoY29udGV4dDogQ29udGV4dCwgZmlsZTogc3RyaW5nKTogUHJvY2Vzc29ySW5wdXRFbnRyeSB7XG4gICAgbGV0IGVudHJ5ID0gbmV3IFByb2Nlc3NvcklucHV0RW50cnkoXG4gICAgICBwYXRoLnJlc29sdmUoY29udGV4dC5zb3VyY2VEaXIsIGZpbGUpLFxuICAgICAgcGF0aC5yZXNvbHZlKGNvbnRleHQud29ya0RpciwgZmlsZSksXG4gICAgICBmYWxzZSxcbiAgICAgIHVuZGVmaW5lZFxuICAgICk7XG5cbiAgICBsZXQgbGFzdEJ1aWxkQ29udGV4dCA9IHRoaXMuZ2V0TGFzdEJ1aWxkQ29udGV4dChjb250ZXh0LmluZGV4KTtcbiAgICAvLyBPcmlnaW5hbCBzb3VyY2UgZmlsZXMgaW4gcmVjb21waWxlU291cmNlcyBzaG91bGQgYmUgY29tcGlsZWRcbiAgICBpZiAoY29udGV4dC5pbmRleCA9PT0gMCkge1xuICAgICAgaWYgKHRoaXMucmVjb21waWxlU291cmNlcy5oYXMoZmlsZSkpIHtcbiAgICAgICAgZW50cnkuc2hvdWxkQ29tcGlsZSA9IHRydWU7XG4gICAgICAgIFV0aWxzLmRiZygpICYmIFV0aWxzLmRlYnVnKGBSZWNvbXBpbGUgJHtmaWxlfSBiZWNhdXNlIGl0c2VsZiBvciBpdHMgZGVwZW5kZW5jaWVzIGhhdmUgY2hhbmdlZC5gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gRmlyc3QgYnVpbGQsIG9yIHByZXZpb3VzIGJ1aWxkIGRpZG4ndCBhZHZhbmNlIHRvIHRoaXMgc3RlcCwgc291cmNlIHNob3VsZCBiZVxuICAgIC8vIGNvbXBpbGVkIHJlZ2FyZGxlc3MuXG4gICAgZWxzZSBpZiAoIWxhc3RCdWlsZENvbnRleHQpIHtcbiAgICAgIGVudHJ5LnNob3VsZENvbXBpbGUgPSB0cnVlO1xuICAgIH1cbiAgICAvLyBObyBvdXB1dCBmcm9tIGxhc3QgZXhlY3Rpb24sIGVpdGhlciB0aGlzIGlzIGEgbmV3IGZpbGUsIG9yIHRoZSBmaWxlXG4gICAgLy8gZmFpbGVkIGNvbXBpbGUgbGFzdCB0aW1lLCBlaXRoZXIgd2F5IGl0IHNob3VsZCBiZSByZS1jb21waWxlZFxuICAgIGVsc2UgaWYgKCFsYXN0QnVpbGRDb250ZXh0Lm91dHB1dC5oYXNTb3VyY2UoZmlsZSkpIHtcbiAgICAgIFV0aWxzLmRiZygpICYmIFV0aWxzLmRlYnVnKGBSZWNvbXBpbGUgJHtmaWxlfSBiZWNhdXNlIGl0J3MgbmV3IG9yIGl0IGZhaWxlZCBsYXN0IHRpbWUuYCk7XG4gICAgICBlbnRyeS5zaG91bGRDb21waWxlID0gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBXaGVuIGNvbXBpbGUgaXMgc2tpcHBlZCwgcHJvY2Vzc29yIG5lZWRzIG91dHB1dCBmcm9tIGxhc3QgYnVpbGQgdG9cbiAgICAvLyBnZW5lcmF0ZSBpdHMgb3duIG91dHB1dFxuICAgIGlmIChsYXN0QnVpbGRDb250ZXh0KSB7XG4gICAgICBlbnRyeS5sYXN0T3V0cHV0ID0gbGFzdEJ1aWxkQ29udGV4dC5vdXRwdXQuZ2V0QnlTb3VyY2UoZmlsZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVudHJ5O1xuICB9XG5cbiAgYmVmb3JlQnVpbGQodGFzazogVGFzayA9IG5ldyBUYXNrKCkpOiB2b2lkIHtcbiAgICBzdXBlci5iZWZvcmVCdWlsZCh0YXNrKTtcbiAgICAvLyBDb21wdXRlIHJlLWNvbXBpbGUgc291cmNlc1xuICAgIHRoaXMucmVjb21waWxlU291cmNlcyA9IFsuLi50YXNrLnZhbHVlcygpXVxuICAgICAgLnJlZHVjZSgoYWxsLCBiYXRjaCkgPT4gYWxsLmNvbmNhdChbLi4uYmF0Y2hdKSwgW10pXG4gICAgICAubWFwKGZpbGUgPT4gdGhpcy5maW5kUmVvbXBpbGVTb3VyY2VzKGZpbGUpKVxuICAgICAgLnJlZHVjZSgoY2FuZHMsIHNvdXJjZXMpID0+IFV0aWxzLnVuaW9uKGNhbmRzLCBzb3VyY2VzKSwgbmV3IFNldCgpKTtcblxuICAgIC8vIFVwZGF0ZSBmaWxlIGxpc3QgYWNjb3JkaW5nIHRvIGZpbGUgc3lzdGVtIHVwZGF0ZVxuICAgIGlmICh0YXNrLmhhcyhFZGl0RXZlbnQuQUREKSkge1xuICAgICAgdGFzay5nZXQoRWRpdEV2ZW50LkFERCkuZm9yRWFjaChmID0+IHRoaXMucnVsZS5maWxlcy5hZGQoZikpO1xuICAgIH1cbiAgICBpZiAodGFzay5oYXMoRWRpdEV2ZW50LkRFTCkpIHtcbiAgICAgIHRhc2suZ2V0KEVkaXRFdmVudC5ERUwpLmZvckVhY2goZiA9PiB0aGlzLnJ1bGUuZmlsZXMuZGVsZXRlKGYpKTtcbiAgICB9XG5cbiAgICAvLyBSZWluaXRpYXRlIFRUU1xuICAgIGlmICh0aGlzLnJ1bGUuZmlsZXMuc2l6ZSkge1xuICAgICAgdGhpcy50YXJnZXRUb1NvdXJjZXMgPSBuZXcgVGFyZ2V0VG9Tb3VyY2VzKCk7XG4gICAgICB0aGlzLnJ1bGUuZmlsZXMuZm9yRWFjaChmID0+IHRoaXMudGFyZ2V0VG9Tb3VyY2VzLnNldChmLCBuZXcgU2V0KFtmXSkpKTtcbiAgICAgIHRoaXMuc291cmNlVG9UYXJnZXRzID0gdGhpcy50YXJnZXRUb1NvdXJjZXMuZmxpcCgpO1xuICAgIH1cbiAgICB0aGlzLmxhc3RCdWlsZENvbnRleHRzID0gdGhpcy5jb250ZXh0cztcbiAgICB0aGlzLmNvbnRleHRzID0gW107XG4gIH1cblxuICAvKipcbiAgICogVHJhbnNmb3JtIHByb2Nlc3NvciBvdXRwdXQgYW5kIHNhdmUgaXQgaW50byBjb250ZXh0LlxuICAgKiBAcGFyYW0gb3V0cHV0IFJlc3VsdHMgcmV0dXJuZWQgYnkgcHJvY2Vzc29yLlxuICAgKi9cbiAgc2F2ZU91dHB1dChvdXRwdXQ6IFByb2Nlc3Nvck91dHB1dCk6IHZvaWQge1xuICAgIHN1cGVyLnNhdmVPdXRwdXQob3V0cHV0KTtcblxuICAgIGxldCBjb250ZXh0ID0gVXRpbHMubGFzdEVsZW1lbnQodGhpcy5jb250ZXh0cyk7XG5cbiAgICAvLyBVcGRhdGUgdGFyZ2V0VG9Tb3VyY2VzTWFwIGFuZCBzb3VyY2VUb1RhcmdldHNNYXBcbiAgICBjb250ZXh0LnRhcmdldFRvU291cmNlcy50cmFjZSh0aGlzLnRhcmdldFRvU291cmNlcyk7XG4gICAgdGhpcy50YXJnZXRUb1NvdXJjZXMgPSBjb250ZXh0LnRhcmdldFRvU291cmNlcztcbiAgICBjb250ZXh0LnNvdXJjZVRvVGFyZ2V0cyA9IHRoaXMuc291cmNlVG9UYXJnZXRzID0gdGhpcy50YXJnZXRUb1NvdXJjZXMuZmxpcCgpO1xuXG4gICAgaWYgKFV0aWxzLmRiZygpKSB7XG4gICAgICBVdGlscy5kZWJ1ZyhgJHt0aGlzLm5hbWV9OiBUVFNgLCB0aGlzLnRhcmdldFRvU291cmNlcyk7XG4gICAgICBVdGlscy5kZWJ1ZyhgJHt0aGlzLm5hbWV9OiBTVFRgLCB0aGlzLnNvdXJjZVRvVGFyZ2V0cyk7XG4gICAgfVxuICB9XG59Il19