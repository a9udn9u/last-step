"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const utils_1 = require("~/utils");
const builder_models_1 = require("~/models/builder-models");
const state_models_1 = require("~/models/state-models");
const state_1 = require("~/states/state");
const processor_models_1 = require("~/models/processor-models");
class IncrementalState extends state_1.State {
    constructor(env, rule) {
        super(env, rule);
        this.targetToSources = new state_models_1.TargetToSources();
        this.sourceToTargets = new state_models_1.SourceToTargets();
        this.recompileSources = new Set();
    }
    /**
     * Find files requring re-compile when the given file changed.
     * First find the targets affected by the changed file, then backtrack each
     * execution context, find the original source of each target.
     *
     * File additions will fall through, but caught later in
     * [processorInput()]{@link IncrementalState#processorInput}
     *
     * @param file The added/updated/deleted file.
     * @returns List of files requiring re-compile.
     */
    findReompileSources(source) {
        let sources = new Set();
        let targets = this.sourceToTargets.get(source);
        if (!targets) {
            sources.add(source);
        }
        else {
            targets.forEach(finalTarget => {
                // Backtracking source
                // TODO: This might be unncecessary though, the key of the output
                // map is the original source (needs confirmation)
                let file = finalTarget;
                for (let i = this.contexts.length - 1; i >= 0; --i) {
                    let context = this.contexts[i];
                    file = context.output.getByTarget(file).source;
                    file = path.relative(context.sourceDir, file);
                }
                sources.add(file);
            });
        }
        utils_1.Utils.dbg() && utils_1.Utils.debug('Re-compile candidates:', sources);
        return sources;
    }
    getLastBuildContext(index) {
        return this.lastBuildContexts ? this.lastBuildContexts[index] : undefined;
    }
    nextRootDir() {
        // At this point, new context hasn't been pushed to this.contexts,
        // so index should be context length without minus one
        let lastBuildContext = this.getLastBuildContext(this.contexts.length);
        return lastBuildContext ? lastBuildContext.rootDir : super.nextRootDir();
    }
    processorInput(context, file) {
        let entry = new processor_models_1.ProcessorInputEntry(path.resolve(context.sourceDir, file), path.resolve(context.workDir, file), false, undefined);
        let lastBuildContext = this.getLastBuildContext(context.index);
        // Original source files in recompileSources should be compiled
        if (context.index === 0) {
            if (this.recompileSources.has(file)) {
                entry.shouldCompile = true;
                utils_1.Utils.dbg() && utils_1.Utils.debug(`Recompile ${file} because itself or its dependencies have changed.`);
            }
        }
        // First build, or previous build didn't advance to this step, source should be
        // compiled regardless.
        if (!lastBuildContext) {
            entry.shouldCompile = true;
        }
        else if (!lastBuildContext.output.hasSource(file)) {
            utils_1.Utils.dbg() && utils_1.Utils.debug(`Recompile ${file} because it's new or it failed last time.`);
            entry.shouldCompile = true;
        }
        if (lastBuildContext)
            utils_1.Utils.warn(file, lastBuildContext.output.hasSource(file), lastBuildContext.output.sources, lastBuildContext.output);
        // When compile is skipped, processor needs output from last build to
        // generate its own output
        if (lastBuildContext) {
            entry.lastOutput = lastBuildContext.output.getBySource(file);
        }
        return entry;
    }
    beforeBuild(task = new builder_models_1.Task()) {
        super.beforeBuild(task);
        // Compute re-compile sources
        this.recompileSources = [...task.values()]
            .reduce((all, batch) => all.concat([...batch]), [])
            .map(file => this.findReompileSources(file))
            .reduce((cands, sources) => utils_1.Utils.union(cands, sources), new Set());
        // Update file list according to file system update
        if (task.has(builder_models_1.EditEvent.ADD)) {
            task.get(builder_models_1.EditEvent.ADD).forEach(f => this.rule.files.add(f));
        }
        if (task.has(builder_models_1.EditEvent.DEL)) {
            task.get(builder_models_1.EditEvent.DEL).forEach(f => this.rule.files.delete(f));
        }
        // Reinitiate TTS
        if (this.rule.files.size) {
            this.targetToSources = new state_models_1.TargetToSources();
            this.rule.files.forEach(f => this.targetToSources.set(f, new Set([f])));
            this.sourceToTargets = this.targetToSources.flip();
        }
        this.lastBuildContexts = this.contexts;
        this.contexts = [];
    }
    /**
     * Transform processor output and save it into context.
     * @param output Results returned by processor.
     */
    saveOutput(output) {
        super.saveOutput(output);
        let context = utils_1.Utils.lastElement(this.contexts);
        // Update targetToSourcesMap and sourceToTargetsMap
        context.targetToSources.trace(this.targetToSources);
        this.targetToSources = context.targetToSources;
        context.sourceToTargets = this.sourceToTargets = this.targetToSources.flip();
        if (utils_1.Utils.dbg()) {
            utils_1.Utils.debug(`${this.name}: TTS`, this.targetToSources);
            utils_1.Utils.debug(`${this.name}: STT`, this.sourceToTargets);
        }
    }
}
exports.IncrementalState = IncrementalState;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5jci1zdGF0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdGF0ZXMvaW5jci1zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3QixtQ0FBZ0M7QUFDaEMsNERBQTZFO0FBQzdFLHdEQUFrRjtBQUNsRiwwQ0FBdUM7QUFDdkMsZ0VBQWlGO0FBRWpGLHNCQUE4QixTQUFRLGFBQUs7SUFxQnpDLFlBQVksR0FBZ0IsRUFBRSxJQUFVO1FBQ3RDLEtBQUssQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLDhCQUFlLEVBQUUsQ0FBQztRQUM3QyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksOEJBQWUsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFFRDs7Ozs7Ozs7OztPQVVHO0lBQ0ssbUJBQW1CLENBQUMsTUFBYztRQUN4QyxJQUFJLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1FBQ2hDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9DLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNiLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRTtnQkFDNUIsc0JBQXNCO2dCQUN0QixpRUFBaUU7Z0JBQ2pFLGtEQUFrRDtnQkFDbEQsSUFBSSxJQUFJLEdBQUcsV0FBVyxDQUFDO2dCQUN2QixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUs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Q25ELE9BQU8sQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsZUFBZSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUM7UUFDL0MsT0FBTyxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFN0UsRUFBRSxDQUFDLENBQUMsYUFBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNoQixhQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksT0FBTyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUN2RCxhQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksT0FBTyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUN6RCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBN0pELDRDQTZKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBVdGlscyB9IGZyb20gJ34vdXRpbHMnO1xuaW1wb3J0IHsgRWRpdEV2ZW50LCBFbnZpcm9ubWVudCwgUnVsZSwgVGFzayB9IGZyb20gJ34vbW9kZWxzL2J1aWxkZXItbW9kZWxzJztcbmltcG9ydCB7IFRhcmdldFRvU291cmNlcywgU291cmNlVG9UYXJnZXRzLCBDb250ZXh0IH0gZnJvbSAnfi9tb2RlbHMvc3RhdGUtbW9kZWxzJztcbmltcG9ydCB7IFN0YXRlIH0gZnJvbSAnfi9zdGF0ZXMvc3RhdGUnO1xuaW1wb3J0IHsgUHJvY2Vzc29yT3V0cHV0LCBQcm9jZXNzb3JJbnB1dEVudHJ5IH0gZnJvbSAnfi9tb2RlbHMvcHJvY2Vzc29yLW1vZGVscyc7XG5cbmV4cG9ydCBjbGFzcyBJbmNyZW1lbnRhbFN0YXRlIGV4dGVuZHMgU3RhdGUge1xuICAvKipcbiAgICogMSB0byBNIG1hcHBpbmcsIGtleSBpcyB0aGUgdGFyZ2V0IGZpbGUsIHZhbHVlIGlzIGEgc2V0IG9mIHNvdXJjZVxuICAgKiBmaWxlcyB3aGljaCBjb21wb3NlIHRoZSB0YXJnZXQgZmlsZVxuICAgKi9cbiAgdGFyZ2V0VG9Tb3VyY2VzOiBUYXJnZXRUb1NvdXJjZXM7XG4gIC8qKlxuICAgKiAxIHRvIE0gbWFwcGluZywga2V5IGlzIHRoZSBzb3VyY2UgZmlsZSwgdmFsdWUgaXMgYSBzZXQgb2YgdGFyZ2V0XG4gICAqIGZpbGVzIHdoaWNoIGNvbnRhaW4gdGhlIHNvdXJjZSBmaWxlXG4gICAqL1xuICBzb3VyY2VUb1RhcmdldHM6IFNvdXJjZVRvVGFyZ2V0cztcbiAgLyoqXG4gICAqIFRoaXMgaXMgYSBzZXQgb2Ygc291cmNlcyB0aGF0IHNob3VsZCBiZSBmb3JjZWQgdG8gcmUtY29tcGlsZSBpbiB0aGVcbiAgICogbmV4dCBpbmNyZW1lbnRhbCBidWlsZFxuICAgKi9cbiAgcmVjb21waWxlU291cmNlczogU2V0PHN0cmluZz47XG4gIC8qKlxuICAgKiBDb25ldHh0IGxpc3QgZnJvbSB0aGUgbGFzdCBidWlsZFxuICAgKi9cbiAgbGFzdEJ1aWxkQ29udGV4dHM6IENvbnRleHRbXTtcblxuICBjb25zdHJ1Y3RvcihlbnY6IEVudmlyb25tZW50LCBydWxlOiBSdWxlKSB7XG4gICAgc3VwZXIoZW52LCBydWxlKTtcbiAgICB0aGlzLnRhcmdldFRvU291cmNlcyA9IG5ldyBUYXJnZXRUb1NvdXJjZXMoKTtcbiAgICB0aGlzLnNvdXJjZVRvVGFyZ2V0cyA9IG5ldyBTb3VyY2VUb1RhcmdldHMoKTtcbiAgICB0aGlzLnJlY29tcGlsZVNvdXJjZXMgPSBuZXcgU2V0KCk7XG4gIH1cblxuICAvKipcbiAgICogRmluZCBmaWxlcyByZXF1cmluZyByZS1jb21waWxlIHdoZW4gdGhlIGdpdmVuIGZpbGUgY2hhbmdlZC5cbiAgICogRmlyc3QgZmluZCB0aGUgdGFyZ2V0cyBhZmZlY3RlZCBieSB0aGUgY2hhbmdlZCBmaWxlLCB0aGVuIGJhY2t0cmFjayBlYWNoXG4gICAqIGV4ZWN1dGlvbiBjb250ZXh0LCBmaW5kIHRoZSBvcmlnaW5hbCBzb3VyY2Ugb2YgZWFjaCB0YXJnZXQuXG4gICAqXG4gICAqIEZpbGUgYWRkaXRpb25zIHdpbGwgZmFsbCB0aHJvdWdoLCBidXQgY2F1Z2h0IGxhdGVyIGluXG4gICAqIFtwcm9jZXNzb3JJbnB1dCgpXXtAbGluayBJbmNyZW1lbnRhbFN0YXRlI3Byb2Nlc3NvcklucHV0fVxuICAgKlxuICAgKiBAcGFyYW0gZmlsZSBUaGUgYWRkZWQvdXBkYXRlZC9kZWxldGVkIGZpbGUuXG4gICAqIEByZXR1cm5zIExpc3Qgb2YgZmlsZXMgcmVxdWlyaW5nIHJlLWNvbXBpbGUuXG4gICAqL1xuICBwcml2YXRlIGZpbmRSZW9tcGlsZVNvdXJjZXMoc291cmNlOiBzdHJpbmcpOiBTZXQ8c3RyaW5nPiB7XG4gICAgbGV0IHNvdXJjZXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBsZXQgdGFyZ2V0cyA9IHRoaXMuc291cmNlVG9UYXJnZXRzLmdldChzb3VyY2UpO1xuICAgIGlmICghdGFyZ2V0cykge1xuICAgICAgc291cmNlcy5hZGQoc291cmNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGFyZ2V0cy5mb3JFYWNoKGZpbmFsVGFyZ2V0ID0+IHtcbiAgICAgICAgLy8gQmFja3RyYWNraW5nIHNvdXJjZVxuICAgICAgICAvLyBUT0RPOiBUaGlzIG1pZ2h0IGJlIHVubmNlY2Vzc2FyeSB0aG91Z2gsIHRoZSBrZXkgb2YgdGhlIG91dHB1dFxuICAgICAgICAvLyBtYXAgaXMgdGhlIG9yaWdpbmFsIHNvdXJjZSAobmVlZHMgY29uZmlybWF0aW9uKVxuICAgICAgICBsZXQgZmlsZSA9IGZpbmFsVGFyZ2V0O1xuICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5jb250ZXh0cy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkge1xuICAgICAgICAgIGxldCBjb250ZXh0ID0gdGhpcy5jb250ZXh0c1tpXTtcbiAgICAgICAgICBmaWxlID0gY29udGV4dC5vdXRwdXQuZ2V0QnlUYXJnZXQoZmlsZSkuc291cmNlO1xuICAgICAgICAgIGZpbGUgPSBwYXRoLnJlbGF0aXZlKGNvbnRleHQuc291cmNlRGlyLCBmaWxlKTtcbiAgICAgICAgfVxuICAgICAgICBzb3VyY2VzLmFkZChmaWxlKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBVdGlscy5kYmcoKSAmJiBVdGlscy5kZWJ1ZygnUmUtY29tcGlsZSBjYW5kaWRhdGVzOicsIHNvdXJjZXMpO1xuICAgIHJldHVybiBzb3VyY2VzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMYXN0QnVpbGRDb250ZXh0KGluZGV4OiBudW1iZXIpOiBDb250ZXh0IHtcbiAgICByZXR1cm4gdGhpcy5sYXN0QnVpbGRDb250ZXh0cyA/IHRoaXMubGFzdEJ1aWxkQ29udGV4dHNbaW5kZXhdIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJvdGVjdGVkIG5leHRSb290RGlyKCk6IHN0cmluZyB7XG4gICAgLy8gQXQgdGhpcyBwb2ludCwgbmV3IGNvbnRleHQgaGFzbid0IGJlZW4gcHVzaGVkIHRvIHRoaXMuY29udGV4dHMsXG4gICAgLy8gc28gaW5kZXggc2hvdWxkIGJlIGNvbnRleHQgbGVuZ3RoIHdpdGhvdXQgbWludXMgb25lXG4gICAgbGV0IGxhc3RCdWlsZENvbnRleHQgPSB0aGlzLmdldExhc3RCdWlsZENvbnRleHQodGhpcy5jb250ZXh0cy5sZW5ndGgpO1xuICAgIHJldHVybiBsYXN0QnVpbGRDb250ZXh0ID8gbGFzdEJ1aWxkQ29udGV4dC5yb290RGlyIDogc3VwZXIubmV4dFJvb3REaXIoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwcm9jZXNzb3JJbnB1dChjb250ZXh0OiBDb250ZXh0LCBmaWxlOiBzdHJpbmcpOiBQcm9jZXNzb3JJbnB1dEVudHJ5IHtcbiAgICBsZXQgZW50cnkgPSBuZXcgUHJvY2Vzc29ySW5wdXRFbnRyeShcbiAgICAgIHBhdGgucmVzb2x2ZShjb250ZXh0LnNvdXJjZURpciwgZmlsZSksXG4gICAgICBwYXRoLnJlc29sdmUoY29udGV4dC53b3JrRGlyLCBmaWxlKSxcbiAgICAgIGZhbHNlLFxuICAgICAgdW5kZWZpbmVkXG4gICAgKTtcblxuICAgIGxldCBsYXN0QnVpbGRDb250ZXh0ID0gdGhpcy5nZXRMYXN0QnVpbGRDb250ZXh0KGNvbnRleHQuaW5kZXgpO1xuICAgIC8vIE9yaWdpbmFsIHNvdXJjZSBmaWxlcyBpbiByZWNvbXBpbGVTb3VyY2VzIHNob3VsZCBiZSBjb21waWxlZFxuICAgIGlmIChjb250ZXh0LmluZGV4ID09PSAwKSB7XG4gICAgICBpZiAodGhpcy5yZWNvbXBpbGVTb3VyY2VzLmhhcyhmaWxlKSkge1xuICAgICAgICBlbnRyeS5zaG91bGRDb21waWxlID0gdHJ1ZTtcbiAgICAgICAgVXRpbHMuZGJnKCkgJiYgVXRpbHMuZGVidWcoYFJlY29tcGlsZSAke2ZpbGV9IGJlY2F1c2UgaXRzZWxmIG9yIGl0cyBkZXBlbmRlbmNpZXMgaGF2ZSBjaGFuZ2VkLmApO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBGaXJzdCBidWlsZCwgb3IgcHJldmlvdXMgYnVpbGQgZGlkbid0IGFkdmFuY2UgdG8gdGhpcyBzdGVwLCBzb3VyY2Ugc2hvdWxkIGJlXG4gICAgLy8gY29tcGlsZWQgcmVnYXJkbGVzcy5cbiAgICBpZiAoIWxhc3RCdWlsZENvbnRleHQpIHtcbiAgICAgIGVudHJ5LnNob3VsZENvbXBpbGUgPSB0cnVlO1xuICAgIH1cbiAgICAvLyBObyBvdXB1dCBmcm9tIGxhc3QgZXhlY3Rpb24sIGVpdGhlciB0aGlzIGlzIGEgbmV3IGZpbGUsIG9yIHRoZSBmaWxlXG4gICAgLy8gZmFpbGVkIGNvbXBpbGUgbGFzdCB0aW1lLCBlaXRoZXIgd2F5IGl0IHNob3VsZCBiZSByZS1jb21waWxlZFxuICAgIGVsc2UgaWYgKCFsYXN0QnVpbGRDb250ZXh0Lm91dHB1dC5oYXNTb3VyY2UoZmlsZSkpIHtcbiAgICAgIFV0aWxzLmRiZygpICYmIFV0aWxzLmRlYnVnKGBSZWNvbXBpbGUgJHtmaWxlfSBiZWNhdXNlIGl0J3MgbmV3IG9yIGl0IGZhaWxlZCBsYXN0IHRpbWUuYCk7XG4gICAgICBlbnRyeS5zaG91bGRDb21waWxlID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKGxhc3RCdWlsZENvbnRleHQpXG4gICAgVXRpbHMud2FybihmaWxlLCBsYXN0QnVpbGRDb250ZXh0Lm91dHB1dC5oYXNTb3VyY2UoZmlsZSksIGxhc3RCdWlsZENvbnRleHQub3V0cHV0LnNvdXJjZXMsIGxhc3RCdWlsZENvbnRleHQub3V0cHV0KVxuXG4gICAgLy8gV2hlbiBjb21waWxlIGlzIHNraXBwZWQsIHByb2Nlc3NvciBuZWVkcyBvdXRwdXQgZnJvbSBsYXN0IGJ1aWxkIHRvXG4gICAgLy8gZ2VuZXJhdGUgaXRzIG93biBvdXRwdXRcbiAgICBpZiAobGFzdEJ1aWxkQ29udGV4dCkge1xuICAgICAgZW50cnkubGFzdE91dHB1dCA9IGxhc3RCdWlsZENvbnRleHQub3V0cHV0LmdldEJ5U291cmNlKGZpbGUpO1xuICAgIH1cblxuICAgIHJldHVybiBlbnRyeTtcbiAgfVxuXG4gIGJlZm9yZUJ1aWxkKHRhc2s6IFRhc2sgPSBuZXcgVGFzaygpKTogdm9pZCB7XG4gICAgc3VwZXIuYmVmb3JlQnVpbGQodGFzayk7XG4gICAgLy8gQ29tcHV0ZSByZS1jb21waWxlIHNvdXJjZXNcbiAgICB0aGlzLnJlY29tcGlsZVNvdXJjZXMgPSBbLi4udGFzay52YWx1ZXMoKV1cbiAgICAgIC5yZWR1Y2UoKGFsbCwgYmF0Y2gpID0+IGFsbC5jb25jYXQoWy4uLmJhdGNoXSksIFtdKVxuICAgICAgLm1hcChmaWxlID0+IHRoaXMuZmluZFJlb21waWxlU291cmNlcyhmaWxlKSlcbiAgICAgIC5yZWR1Y2UoKGNhbmRzLCBzb3VyY2VzKSA9PiBVdGlscy51bmlvbihjYW5kcywgc291cmNlcyksIG5ldyBTZXQoKSk7XG5cbiAgICAvLyBVcGRhdGUgZmlsZSBsaXN0IGFjY29yZGluZyB0byBmaWxlIHN5c3RlbSB1cGRhdGVcbiAgICBpZiAodGFzay5oYXMoRWRpdEV2ZW50LkFERCkpIHtcbiAgICAgIHRhc2suZ2V0KEVkaXRFdmVudC5BREQpLmZvckVhY2goZiA9PiB0aGlzLnJ1bGUuZmlsZXMuYWRkKGYpKTtcbiAgICB9XG4gICAgaWYgKHRhc2suaGFzKEVkaXRFdmVudC5ERUwpKSB7XG4gICAgICB0YXNrLmdldChFZGl0RXZlbnQuREVMKS5mb3JFYWNoKGYgPT4gdGhpcy5ydWxlLmZpbGVzLmRlbGV0ZShmKSk7XG4gICAgfVxuXG4gICAgLy8gUmVpbml0aWF0ZSBUVFNcbiAgICBpZiAodGhpcy5ydWxlLmZpbGVzLnNpemUpIHtcbiAgICAgIHRoaXMudGFyZ2V0VG9Tb3VyY2VzID0gbmV3IFRhcmdldFRvU291cmNlcygpO1xuICAgICAgdGhpcy5ydWxlLmZpbGVzLmZvckVhY2goZiA9PiB0aGlzLnRhcmdldFRvU291cmNlcy5zZXQoZiwgbmV3IFNldChbZl0pKSk7XG4gICAgICB0aGlzLnNvdXJjZVRvVGFyZ2V0cyA9IHRoaXMudGFyZ2V0VG9Tb3VyY2VzLmZsaXAoKTtcbiAgICB9XG4gICAgdGhpcy5sYXN0QnVpbGRDb250ZXh0cyA9IHRoaXMuY29udGV4dHM7XG4gICAgdGhpcy5jb250ZXh0cyA9IFtdO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYW5zZm9ybSBwcm9jZXNzb3Igb3V0cHV0IGFuZCBzYXZlIGl0IGludG8gY29udGV4dC5cbiAgICogQHBhcmFtIG91dHB1dCBSZXN1bHRzIHJldHVybmVkIGJ5IHByb2Nlc3Nvci5cbiAgICovXG4gIHNhdmVPdXRwdXQob3V0cHV0OiBQcm9jZXNzb3JPdXRwdXQpOiB2b2lkIHtcbiAgICBzdXBlci5zYXZlT3V0cHV0KG91dHB1dCk7XG5cbiAgICBsZXQgY29udGV4dCA9IFV0aWxzLmxhc3RFbGVtZW50KHRoaXMuY29udGV4dHMpO1xuXG4gICAgLy8gVXBkYXRlIHRhcmdldFRvU291cmNlc01hcCBhbmQgc291cmNlVG9UYXJnZXRzTWFwXG4gICAgY29udGV4dC50YXJnZXRUb1NvdXJjZXMudHJhY2UodGhpcy50YXJnZXRUb1NvdXJjZXMpO1xuICAgIHRoaXMudGFyZ2V0VG9Tb3VyY2VzID0gY29udGV4dC50YXJnZXRUb1NvdXJjZXM7XG4gICAgY29udGV4dC5zb3VyY2VUb1RhcmdldHMgPSB0aGlzLnNvdXJjZVRvVGFyZ2V0cyA9IHRoaXMudGFyZ2V0VG9Tb3VyY2VzLmZsaXAoKTtcblxuICAgIGlmIChVdGlscy5kYmcoKSkge1xuICAgICAgVXRpbHMuZGVidWcoYCR7dGhpcy5uYW1lfTogVFRTYCwgdGhpcy50YXJnZXRUb1NvdXJjZXMpO1xuICAgICAgVXRpbHMuZGVidWcoYCR7dGhpcy5uYW1lfTogU1RUYCwgdGhpcy5zb3VyY2VUb1RhcmdldHMpO1xuICAgIH1cbiAgfVxufSJdfQ==